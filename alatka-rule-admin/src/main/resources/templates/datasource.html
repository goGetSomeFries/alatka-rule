<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alatka-rule-admin</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap-table/dist/bootstrap-table.css}"/>
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#" th:text="#{app.name}">MyApp</a>
        <div class="navbar-nav">
            <a class="nav-link active" href="#">首页</a>
            <a class="nav-link" href="#">关于</a>
            <a class="nav-link" href="#">联系我们</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="card mb-3">
        <div class="card-header bg-light">
            <h5 class="mb-0">规则外部数据源查询</h5>
        </div>
        <div class="card-body">
            <form id="searchForm" class="row g-3">
                <div class="col-md-3">
                    <label for="key" class="form-label">关键字</label>
                    <input type="text" class="form-control" id="key" name="key" placeholder="输入关键字">
                </div>
                <div class="col-md-3">
                    <label for="name" class="form-label">名称</label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="输入名称">
                </div>
                <div class="col-md-3">
                    <label for="type" class="form-label">类型</label>
                    <select class="form-select" id="type" name="type">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="scope" class="form-label">数据范围</label>
                    <select class="form-select" id="scope" name="scope">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="groupKey" class="form-label">规则组关键字</label>
                    <select class="form-select" id="groupKey" name="groupKey">
                        <option value="default_" selected>默认</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="enabled" class="form-label">是否可用</label>
                    <select class="form-select" id="enabled" name="enabled">
                        <option value="">全部</option>
                        <option value="true" selected>正常</option>
                        <option value="false">禁用</option>
                    </select>
                </div>
                <div class="col-12 text-center">
                    <button type="button" class="btn btn-secondary me-2" id="resetButton">
                        <i class="bi bi-arrow-counterclockwise"></i> 重置
                    </button>
                    <button type="button" class="btn btn-primary" id="searchButton">
                        <i class="bi bi-search"></i> 查询
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div class="col-12 text-end">
        <button type="button" class="btn btn-primary" id="addButton"
                onclick="showAddModal('/rule/datasource/create')">
            <i class="bi bi-search"></i> 新增
        </button>
        <button type="button" class="btn btn-outline-warning" id="editButton"
                onclick="showEditModal('/rule/datasource/update')">
            <i class="bi bi-search"></i> 更新
        </button>
        <button type="button" class="btn btn-danger" id="deleteButton"
                onclick="showDeleteModal('/rule/datasource/delete')">
            <i class="bi bi-search"></i> 删除
        </button>
    </div>

    <table id="dataTable"
           data-toggle="table"
           data-method="get"
           data-url="/rule/datasource/page"
           data-sort-name="id"
           data-sort-order="desc"
           data-striped="true"
           data-pagination="true"
           data-detail-view="true"
           data-detail-view-by-click="true"
           data-detail-formatter="detailFormatter"
           data-pagination-loop="false"
           data-side-pagination="server"
           data-click-to-select="true"
           data-maintain-selected="true">
        <thead>
        <tr>
            <th data-radio="true"></th>
            <th data-field="id">ID</th>
            <th data-field="key" data-sortable="true">关键字</th>
            <th data-field="name" data-sortable="true">名称</th>
            <th data-field="type">类型</th>
            <th data-field="scope">数据范围</th>
            <th data-field="groupKey">规则组关键字</th>
            <th data-field="enabled" data-formatter="enabledFormatter">是否可用</th>
        </tr>
        </thead>
    </table>
</div>

<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新增规则外部数据源</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addKey" class="form-label">关键字</label>
                            <input type="text" class="form-control" id="addKey" name="key" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addName" class="form-label">名称</label>
                            <input type="text" class="form-control" id="addName" name="name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addType" class="form-label">类型</label>
                            <select class="form-select" id="addType" name="type" required>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addScope" class="form-label">数据范围</label>
                            <select class="form-select" id="addScope" name="scope" required>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="addGroupKey" class="form-label">规则组关键字</label>
                            <select class="form-select" id="addGroupKey" name="groupKey" required>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="addEnabled" class="form-label">是否可用</label>
                            <select class="form-select" id="addEnabled" name="enabled" required>
                                <option value="true" selected>正常</option>
                                <option value="false">禁用</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between align-items-center">
                            扩展属性
                            <button type="button" class="btn btn-sm btn-success" id="addExtendedBtn">
                                <i class="bi bi-plus"></i> 添加
                            </button>
                        </label>
                        <div id="extendedPropertiesContainer">
                            <div class="extended-property row g-2 mb-2">
                                <div class="col-md-4">
                                    <label>
                                        <input type="text" class="form-control" name="extendedKey[]" placeholder="键"
                                               required>
                                    </label>
                                </div>
                                <div class="col-md-6">
                                    <label>
                                        <input type="text" class="form-control" name="extendedValue[]" placeholder="值"
                                               required>
                                    </label>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button type="button" class="btn btn-sm btn-danger remove-extended">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveAddBtn">确认</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑规则组</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId" name="id">
                    <div class="mb-3">
                        <label for="editKey" class="form-label">关键字</label>
                        <input type="text" class="form-control" id="editKey" name="key" required>
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">名称</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editType" class="form-label">类型</label>
                        <select class="form-select" id="editType" name="type" required>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editEnabled" class="form-label">是否可用</label>
                        <select class="form-select" id="editEnabled" name="enabled" required>
                            <option value="true">正常</option>
                            <option value="false">禁用</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">确认</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">删除规则外部数据源</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除选中的记录？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="saveDeleteBtn">确认</button>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/webjars/jquery/jquery.js}"></script>
<script th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>
<script th:src="@{/webjars/bootstrap-table/dist/bootstrap-table.js}"></script>
<script th:src="@{/webjars/bootstrap-table/dist/locale/bootstrap-table-zh-CN.js}"></script>
<script th:src="@{/js/table.js}"></script>
<script>
    initRuleGroupSelect();
    initTypeSelect();
    initScopeSelect();

    $('#addExtendedBtn').click(function () {
        const property =
            `
         <div class="extended-property row g-2 mb-2">
             <div class="col-md-4">
                 <label>
                     <input type="text" class="form-control" name="extendedKey[]" placeholder="键"
                            required>
                 </label>
             </div>
             <div class="col-md-6">
                 <label>
                     <input type="text" class="form-control" name="extendedValue[]" placeholder="值"
                            required>
                 </label>
             </div>
             <div class="col-md-2 text-end">
                 <button type="button" class="btn btn-sm btn-danger remove-extended">
                     <i class="bi bi-trash"></i> 删除
                 </button>
             </div>
         </div>
       `;
        $('#extendedPropertiesContainer').append(property);
    });

    $('#extendedPropertiesContainer').on('click', '.remove-extended', function () {
        $(this).closest('.extended-property').remove();
    });

    function detailFormatter(index, row) {
        const map = new Map(Object.entries(row.extended));
        const html = [];
        html.push('<dl class="row">');
        map.forEach((value, key) => {
            html.push('<dt class="col-sm-2 text-end">' + key + ': </dt><dd class="col-sm-10">' + value + '</dd>');
        })
        html.push('</dl>');
        return html.join('');
    }


    function initScopeSelect() {
        $.ajax({
            url: '/rule/datasource/scope',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response.code === "0000") {
                    response.data.forEach((value) => {
                        $('#scope').append($('<option>', {value: value, text: value}));
                        $('#addScope').append($('<option>', {value: value, text: value}));
                        $('#editScope').append($('<option>', {value: value, text: value}));
                    });
                } else {
                    showErrorToast("失败: " + response.msg);
                }
            },
            error: function (xhr) {
                showErrorToast("请求失败: " + xhr.responseJSON?.message || "未知错误");
            }
        });
    }

    function initTypeSelect() {
        $.ajax({
            url: '/rule/datasource/type',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response.code === "0000") {
                    response.data.forEach((value) => {
                        $('#type').append($('<option>', {value: value, text: value}));
                        $('#addType').append($('<option>', {value: value, text: value}));
                        $('#editType').append($('<option>', {value: value, text: value}));
                    });
                } else {
                    showErrorToast("失败: " + response.msg);
                }
            },
            error: function (xhr) {
                showErrorToast("请求失败: " + xhr.responseJSON?.message || "未知错误");
            }
        });
    }

    function showAddModal(url) {
        $('#addForm')[0]?.reset();
        $('#addModal').modal('show');

        $('#saveAddBtn').off('click').on('click', function () {
            const formData = {};
            $('#addForm').serializeArray().forEach(item => {
                formData[item.name] = item.value;
            });
            submitFunction(url, 'POST', formData, '新增');
            $('#addModal').modal('hide');
        });
    }
</script>
</body>
</html>