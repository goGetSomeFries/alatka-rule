<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alatka-rule-admin</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap-icons/font/bootstrap-icons.min.css}"/>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap-table/dist/bootstrap-table.css}"/>
</head>
<body>
<!--
&lt;!&ndash; 导航栏 &ndash;&gt;
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#" th:text="#{app.name}">MyApp</a>
        <div class="navbar-nav">
            <a class="nav-link active" href="#">首页</a>
            <a class="nav-link" href="#">关于</a>
            <a class="nav-link" href="#">联系我们</a>
        </div>
    </div>
</nav>
-->

<div class="container mt-4">
    <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">规则查询</h5>
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#cardCollapse"
                    aria-expanded="true"
                    aria-controls="cardCollapse">
                <i class="bi bi-arrows-angle-contract"></i>
            </button>
        </div>
        <div class="card-body collapse show" id="cardCollapse">
            <form id="searchForm" class="row g-3">
                <div class="col-md-3">
                    <label for="name" class="form-label">名称</label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="输入名称">
                </div>
                <div class="col-md-6">
                    <label for="desc" class="form-label">描述</label>
                    <input type="text" class="form-control" id="desc" name="desc" placeholder="输入名称">
                </div>
                <div class="col-md-3">
                    <label for="type" class="form-label">类型</label>
                    <select class="form-select" id="type" name="type">
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="groupKey" class="form-label">规则组名称</label>
                    <select class="form-select" id="groupKey" name="groupKey">
                        <option value="default_" selected>默认</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="enabled" class="form-label">是否可用</label>
                    <select class="form-select" id="enabled" name="enabled">
                        <option value="">全部</option>
                        <option value="true" selected>正常</option>
                        <option value="false">禁用</option>
                    </select>
                </div>
                <div class="col-12 text-center">
                    <button type="button" class="btn btn-secondary me-2" id="resetButton">
                        <i class="bi bi-arrow-counterclockwise"></i> 重置
                    </button>
                    <button type="button" class="btn btn-primary" id="searchButton">
                        <i class="bi bi-search"></i> 查询
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div class="col-12 text-end mb-3">
        <button type="button" class="btn btn-sm btn-outline-info" id="addButton"
                onclick="showEditModal('/rule/create', true)">
            <i class="bi bi-plus-lg"></i> 新增
        </button>
        <button type="button" class="btn btn-sm btn-outline-warning" id="editButton"
                onclick="showEditModal('/rule/update', false)">
            <i class="bi bi-pencil-square"></i> 更新
        </button>
        <button type="button" class="btn btn-sm btn-danger" id="deleteButton"
                onclick="showDeleteModal('/rule/delete')">
            <i class="bi bi-trash"></i> 删除
        </button>
    </div>

    <table id="dataTable"
           data-toggle="table"
           data-method="get"
           data-url="/rule/page"
           data-sort-name="id"
           data-sort-order="desc"
           data-striped="true"
           data-pagination="true"
           data-detail-view="true"
           data-detail-formatter="detailFormatter"
           data-pagination-loop="false"
           data-side-pagination="server"
           data-click-to-select="true"
           data-maintain-selected="true">
        <thead>
        <tr>
            <th data-radio="true"></th>
            <th data-field="id">ID</th>
            <th data-field="type" data-formatter="typeFormatter">类型</th>
            <th data-field="name" data-sortable="true">名称</th>
            <th data-field="desc">描述</th>
            <th data-field="priority" data-sortable="true">优先级</th>
            <th data-field="score" data-sortable="true">评分</th>
            <th data-field="order" data-sortable="true">顺序</th>
            <th data-field="groupKey" data-formatter="groupKeyFormatter">规则组名称</th>
            <th data-field="enabled" data-formatter="enabledFormatter">是否可用</th>
        </tr>
        </thead>
    </table>
    <div class="accordion" id="accordionExample">
        <div class="accordion-item">
            <h3 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne"
                        aria-expanded="true" aria-controls="collapseOne">
                    Accordion Item #1
                </button>
            </h3>
            <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <strong>This is the first item’s accordion body.</strong> It is shown by default, until the collapse
                    plugin adds the appropriate classes that we use to style each element. These classes control the
                    overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of
                    this with custom CSS or overriding our default variables. It’s also worth noting that just about any
                    HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    Accordion Item #2
                </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <strong>This is the second item’s accordion body.</strong> It is hidden by default, until the
                    collapse plugin adds the appropriate classes that we use to style each element. These classes
                    control the overall appearance, as well as the showing and hiding via CSS transitions. You can
                    modify any of this with custom CSS or overriding our default variables. It’s also worth noting that
                    just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit
                    overflow.
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                    Accordion Item #3
                </button>
            </h2>
            <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <strong>This is the third item’s accordion body.</strong> It is hidden by default, until the
                    collapse plugin adds the appropriate classes that we use to style each element. These classes
                    control the overall appearance, as well as the showing and hiding via CSS transitions. You can
                    modify any of this with custom CSS or overriding our default variables. It’s also worth noting that
                    just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit
                    overflow.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑规则</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId" name="id">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editType" class="form-label">类型</label>
                            <select class="form-select" id="editType" name="type" required>
                            </select>
                        </div>
                        <div风险账户9星 class="col-md-8 mb-3">
                            <label for="editName" class="form-label">名称</label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div风险账户9星>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="editDesc" class="form-label">描述</label>
                            <textarea class="form-control" rows="3" id="editDesc" name="desc"
                                      required></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editPriority" class="form-label">优先级</label>
                            <input type="number" class="form-control" id="editPriority" name="priority" value="0"
                                   required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editScore" class="form-label">评分</label>
                            <input type="number" class="form-control" id="editScore" name="score" value="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editOrder" class="form-label">顺序</label>
                            <input type="number" class="form-control" id="editOrder" name="order" value="0" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editGroupKey" class="form-label">规则组名称</label>
                            <select class="form-select" id="editGroupKey" name="groupKey" required>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editEnabled" class="form-label">是否可用</label>
                            <select class="form-select" id="editEnabled" name="enabled" required>
                                <option value="true" selected>正常</option>
                                <option value="false">禁用</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between align-items-center">
                            扩展属性
                            <button type="button" class="btn btn-sm btn-success" id="addExtendedBtn">
                                <i class="bi bi-plus"></i> 添加
                            </button>
                        </label>
                        <div id="extendedPropertiesContainer">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">确认</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">删除规则</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除选中的记录？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="saveDeleteBtn">确认</button>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/webjars/jquery/jquery.js}"></script>
<script th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>
<script th:src="@{/webjars/bootstrap-table/dist/bootstrap-table.js}"></script>
<script th:src="@{/webjars/bootstrap-table/dist/locale/bootstrap-table-zh-CN.js}"></script>
<script th:src="@{/js/table.js}"></script>
<script>
    initRuleGroupSelect();
    initTypeSelect();
    initExtended();

    function initTypeSelect() {
        httpClient('/rule/type', 'GET', null, function (data) {
            const map = new Map(Object.entries(data));
            map.forEach((value, key) => {
                $('#type').append($('<option>', {value: key, text: value}))
                $('#editType').append($('<option>', {value: key, text: value}))
            });
        });
    }

    function typeFormatter(arg) {
        const keyValuePairs = {};
        $('select#type option').each(function () {
            keyValuePairs[$(this).val()] = $(this).text();
        });
        return keyValuePairs[arg];
    }

    function showEditModal(url, created) {
        if (created) {
            $('#editForm')[0]?.reset();
            $('#extendedPropertiesContainer').empty();
        } else {
            const selection = $('#dataTable').bootstrapTable('getSelections');
            if (selection.length !== 1) {
                showWarningToast("请选择一条记录进行编辑");
                return;
            }

            const row = selection[0];
            Object.keys(row).forEach(field => {
                const $input = $(`#editForm [name="${field}"], #editForm #${field}`);
                if ($input.length) {
                    let value = row[field];
                    if (typeof value === 'boolean') {
                        value = value ? 'true' : 'false';
                    }
                    $input.val(value);
                }
            });

            $('#extendedPropertiesContainer').empty();
            const map = new Map(Object.entries(row.extended));
            map.forEach((value, key) => {
                const property =
                    `
                    <div class="extended-property row g-2 mb-2">
                        <div class="col-md-4">
                            <label>
                                <input type="text" class="form-control" name="extendedKey" placeholder="键" value="${key}"
                                       required>
                            </label>
                        </div>
                        <div class="col-md-6">
                            <label>
                                <input type="text" class="form-control" name="extendedValue" placeholder="值" value="${value}"
                                       required>
                            </label>
                        </div>
                        <div class="col-md-2 text-end">
                            <button type="button" class="btn btn-sm btn-danger remove-extended">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                  `;
                $('#extendedPropertiesContainer').append(property);
            });
        }

        $('#editModal').modal('show');

        $('#saveEditBtn').off('click').on('click', function (event) {
            const formData = {};
            const $editForm = $('#editForm');
            if (!$editForm[0].checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                $editForm.addClass('was-validated');
            } else {
                $editForm.serializeArray()
                    .filter(item => {
                        return item.name !== 'extendedKey'
                            && item.name !== 'extendedValue';
                    }).forEach(item => {
                    formData[item.name] = item.value;
                });
                const keys = $('#extendedPropertiesContainer input[name="extendedKey"]').map(function () {
                    return $(this).val();
                }).get();
                const values = $('#extendedPropertiesContainer input[name="extendedValue"]').map(function () {
                    return $(this).val();
                }).get();

                const extended = {};
                keys.forEach((key, index) => {
                    if (key && index < values.length) {
                        extended[key] = values[index];
                    }
                });
                formData['extended'] = extended;

                submitFunction(url, created ? 'POST' : 'PUT', formData, created ? '新增' : '更新');
                $('#editModal').modal('hide');
            }
        });
    }
</script>
</body>
</html>